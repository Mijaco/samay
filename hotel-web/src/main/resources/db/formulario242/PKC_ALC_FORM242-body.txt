create or replace package body PKC_ALC_FORM242 is

PROCEDURE PRC_LISTADO_HEADER_FORM242(
    --Parametros de la busqueda
   P_FECHA_MUESTREO          IN VARCHAR2,
   --PARAMETROS DE LA PAGINACION
   PAR_COL_ORDER_BY     IN INTEGER, 
   PAR_COL_ORDER_BY_DIR IN VARCHAR2 , 
   PAR_PAG_DESDE        IN INTEGER, 
   PAR_CANTIDAD_PAG     IN INTEGER,
   --PARAMETROS DE RETORNO
   PAR_OUT_QUANTITY     OUT INTEGER,
   PAR_OUT_CURSOR       OUT SYS_REFCURSOR  
       
 )
 IS
v_query VARCHAR2(4000);
v_query_from VARCHAR2(4000);
v_query_count VARCHAR2(4000);
v_query_where VARCHAR2(4000);

BEGIN

  v_query_count:= ' select count(*) ';

  v_query :=  'SELECT * 
                 FROM(SELECT a.*, rownum rn 
                        FROM(SELECT  
                                    TO_CHAR(H.D_FECMUE, ''DD/MM/YYYY HH:MI:SS AM''), 
                                    TO_CHAR(H.D_RECMUE, ''DD/MM/YYYY HH:MI:SS AM''), 
                                    A.C_DDCATL AS C,
                                    B.C_DDCATL AS D,     
                                    H.N_CODHFO 
                                       ';

  v_query_from := ' FROM ALC_FORMULHEADER H 
                                           INNER JOIN ALC_DETCATLG A ON H.C_PERMUE = A.C_VALCAT AND A.N_CCATLG=10
                                           INNER JOIN ALC_DETCATLG B ON H.C_PERECE = B.C_VALCAT AND B.N_CCATLG=11    
                                           WHERE ';

  v_query := v_query || v_query_from;
  v_query_count := v_query_count || v_query_from;

  v_query_where := ' 1=1 ';
  
  
   if(LENGTH(TRIM(P_FECHA_MUESTREO))>0) then
    v_query_where :=  v_query_where || ' AND TO_CHAR(H.D_FECMUE, '''||'DD/MM/YYYY'||''') >= ''' || P_FECHA_MUESTREO ||''' AND ';
    v_query_where :=  v_query_where || '     TO_CHAR(H.D_FECMUE, '''||'DD/MM/YYYY'||''') <= ''' || P_FECHA_MUESTREO ||'''  ';  
              
   end if;
  
  v_query := v_query||v_query_where;
  v_query_count := v_query_count||v_query_where;
  
  v_query := v_query || ' order by '||par_col_order_by || ' ' ||par_col_order_by_dir || ' ) a ) WHERE rn > ' || par_pag_desde || ' and rn <= ' || (par_pag_desde+par_cantidad_pag);
    
  OPEN par_out_cursor FOR v_query;
  
  execute immediate v_query_count into par_out_quantity;
END;


PROCEDURE PRC_INSERT_HEADER(
  
   P_FECHA_MUESTREO                 IN VARCHAR2,
   P_FECHA_RECEPCION                IN VARCHAR2,
   P_PERSONA_MUESTREA               ALC_FORMULHEADER.C_PERMUE%TYPE,
   P_PERSONA_RECEPCION              ALC_FORMULHEADER.C_PERECE%TYPE,
   P_OBSERVACION                    ALC_FORMULHEADER.C_OBSERV%TYPE,
   --Campos de Auditoria
   A_PAR_USUARIO_CREACION           ALC_FORMULHEADER.A_USUCRE%TYPE,
   A_PAR_USUARIO_MODIFICACION       ALC_FORMULHEADER.A_USUMOD%TYPE,
   A_PAR_NOMBRE_PROGRAMA            ALC_FORMULHEADER.A_NOMPRG%TYPE
 )
 
 IS
 BEGIN
   
 INSERT INTO ALC_FORMULHEADER
      ( 
         A_USUCRE,
         A_FECCRE,
         A_USUMOD,
         A_FECMOD,
         A_NOMPRG,
         N_CODHFO,
         D_FECMUE,
         D_RECMUE,
         C_PERMUE,  
         C_PERECE,
         C_OBSERV
       )
 VALUES
      (
         A_PAR_USUARIO_CREACION,
         SYSDATE,
         A_PAR_USUARIO_MODIFICACION,
         SYSDATE, 
         A_PAR_NOMBRE_PROGRAMA,
         SQ_ALC_FORMULHEADER.NEXTVAL,
         TO_DATE(P_FECHA_MUESTREO, 'DD/MM/YYYY HH24:MI:SS'),
         TO_DATE(P_FECHA_RECEPCION, 'DD/MM/YYYY HH24:MI:SS'),
         P_PERSONA_MUESTREA,
         P_PERSONA_RECEPCION,
         P_OBSERVACION
       );

END;

PROCEDURE PRC_INSERT_DETALLE(

   P_LOCALIDAD_MUESTREO          ALC_MUESTRFOR242.C_LOCMUE%TYPE,
   P_ESTACION_MUESTREO           ALC_MUESTRFOR242.C_ESTMUE%TYPE,
   P_ALTURA                      ALC_MUESTRFOR242.C_ALTURA%TYPE,
   P_HORA                        IN VARCHAR2, -- ALC_MUESTRFOR242.D_HORMUE%TYPE,
   P_COORD_W                     ALC_MUESTRFOR242.C_COORDW%TYPE,
   P_COORD_E                     ALC_MUESTRFOR242.C_COORDE%TYPE,
   P_PH                          ALC_MUESTRFOR242.C_PH%TYPE,
   P_TEMPERATURA                 ALC_MUESTRFOR242.C_TEMPEC%TYPE,
   P_CONDUCTIVIDAD               ALC_MUESTRFOR242.C_CONDUC%TYPE,
   P_TURBIEDAD                   ALC_MUESTRFOR242.C_TURBIE%TYPE,
   P_OXIGENO                     ALC_MUESTRFOR242.C_OXIGEN%TYPE,
   P_CLOROFILA                   ALC_MUESTRFOR242.C_CLOROF%TYPE,
   /*P_FICO                        ALC_MUESTRFOR242.C_F*/
   P_OBSERVACION                 ALC_MUESTRFOR242.C_OBSERV%TYPE,
   P_CODIGO_HEADER               ALC_MUESTRFOR242.N_CODHFO%TYPE,
   --Campos de Auditoria
   A_PAR_USUARIO_CREACION        ALC_MUESTRFOR242.A_USUCRE%TYPE,
   A_PAR_USUARIO_MODIFICACION    ALC_MUESTRFOR242.A_USUMOD%TYPE,
   A_PAR_NOMBRE_PROGRAMA         ALC_MUESTRFOR242.A_NOMPRG%TYPE
 )
 
 IS
 BEGIN
   
 INSERT INTO ALC_MUESTRFOR242
      ( 
         A_USUCRE,
         A_FECCRE,
         A_USUMOD,
         A_FECMOD,
         A_NOMPRG,
         N_CODMUE, 
         C_LOCMUE, 
         C_ESTMUE, 
         C_ALTURA, 
         D_HORMUE, 
         C_COORDW, 
         C_COORDE, 
         C_PH, 
         C_TEMPEC,
         C_CONDUC, 
         C_TURBIE, 
         C_OXIGEN, 
         C_CLOROF, 
         C_OBSERV,
         N_CODHFO,
         N_STATUS
       )
 VALUES
      (
         A_PAR_USUARIO_CREACION,
         SYSDATE,
         A_PAR_USUARIO_MODIFICACION,
         SYSDATE, 
         A_PAR_NOMBRE_PROGRAMA,
         SQ_ALC_MUESTRFOR242.NEXTVAL,
         P_LOCALIDAD_MUESTREO,
         P_ESTACION_MUESTREO,
         P_ALTURA,
         P_HORA,
         P_COORD_W,
         P_COORD_E,
         P_PH,
         P_TEMPERATURA,
         P_CONDUCTIVIDAD,
         P_TURBIEDAD,
         P_OXIGENO,
         P_CLOROFILA,
         P_OBSERVACION,
         P_CODIGO_HEADER,
         1
         
      --   P_FICO
       );

END;

PROCEDURE PRC_GET_HEADER(
   --Parametros de la busqueda
   P_ID_REGISTRO   IN    ALC_FORMULHEADER.N_CODHFO%TYPE,
   --Parametros de retorno
   par_out_cursor OUT SYS_REFCURSOR  
)
IS

BEGIN
  
   OPEN PAR_OUT_CURSOR FOR
   SELECT  
        TO_CHAR(D_FECMUE,'DD/MM/YYYY HH24:MI:SS'),
        TO_CHAR(D_RECMUE,'DD/MM/YYYY HH24:MI:SS'),
        C_PERMUE, 
        C_PERECE,
        C_OBSERV,
        N_CODHFO
     
FROM   ALC_FORMULHEADER
     
WHERE N_CODHFO = P_ID_REGISTRO;

END;

PROCEDURE PRC_LISTADO_DETALLE(
    --Parametros de la busqueda
   P_COD_HEADER         ALC_FORMULHEADER.N_CODHFO%TYPE,
   --PARAMETROS DE LA PAGINACION
   PAR_COL_ORDER_BY     IN INTEGER, 
   PAR_COL_ORDER_BY_DIR IN VARCHAR2 , 
   PAR_PAG_DESDE        IN INTEGER, 
   PAR_CANTIDAD_PAG     IN INTEGER,
   --PARAMETROS DE RETORNO
   PAR_OUT_QUANTITY     OUT INTEGER,
   PAR_OUT_CURSOR       OUT SYS_REFCURSOR  
       
)
 IS
v_query VARCHAR2(4000);
v_query_from VARCHAR2(4000);
v_query_count VARCHAR2(4000);
v_query_where VARCHAR2(4000);

BEGIN

  v_query_count:= ' select count(*) ';

  v_query :=  'SELECT * 
                 FROM(SELECT a.*, rownum rn 
                        FROM(SELECT  C.C_DDCATL AS E, 
                                     D.C_DDCATL AS F, 
                                     B.C_COORDW AS G, 
                                     B.C_COORDE AS H, 
                                     B.C_ALTURA AS I, 
                                     B.D_HORMUE AS J, 
                                     B.C_PH     AS K, 
                                     B.C_TEMPEC AS L,
                                     B.C_CONDUC AS M, 
                                     B.C_TURBIE AS N, 
                                     B.C_OXIGEN AS O, 
                                     B.C_CLOROF AS P, 
                                     B.C_OBSERV AS Q, 
                                     B.N_CODMUE AS R,
                                     A.N_CODHFO AS S
                                       ';

  v_query_from := ' FROM ALC_FORMULHEADER A 
                         INNER JOIN ALC_MUESTRFOR242 B ON B.N_CODHFO = A.N_CODHFO
                         INNER JOIN ALC_DETCATLG     C ON C.C_VALCAT = B.C_LOCMUE AND C.N_CCATLG = 3
                         INNER JOIN ALC_DETCATLG     D ON D.C_VALCAT = B.C_ESTMUE AND D.N_CCATLG = 6    
                    WHERE ';

  v_query := v_query || v_query_from;
  v_query_count := v_query_count || v_query_from;

  v_query_where := ' 1=1 ';
  
  v_query_where :=  v_query_where || ' AND A.N_CODHFO = ''' || P_COD_HEADER ||''' AND B.N_STATUS = 1 '; 
  
  v_query := v_query||v_query_where;
  v_query_count := v_query_count||v_query_where;
  
  v_query := v_query || ' order by '||par_col_order_by || ' ' ||par_col_order_by_dir || ' ) a ) WHERE rn > ' || par_pag_desde || ' and rn <= ' || (par_pag_desde+par_cantidad_pag);
    
  OPEN par_out_cursor FOR v_query;
  
  execute immediate v_query_count into par_out_quantity;
END;

PROCEDURE PRC_INACTIVA_DETALLE(

P_IDDETALLE                 ALC_MUESTRFOR242.N_CODMUE%TYPE,
P_ESTADO                    ALC_MUESTRFOR242.N_STATUS%TYPE,
A_PAR_USUARIO_MODIFICACION  ALC_MUESTRFOR242.A_USUMOD%TYPE
)

IS 
BEGIN
  
  UPDATE ALC_MUESTRFOR242 SET N_STATUS = P_ESTADO,
                              A_USUMOD = A_PAR_USUARIO_MODIFICACION
  WHERE N_CODMUE = P_IDDETALLE;
  
END;

PROCEDURE PRC_GET_DETALLE(
   --Parametros de la busqueda
   P_ID_DETALLE   IN    ALC_MUESTRFOR242.N_CODMUE%TYPE,
   --Parametros de retorno
   par_out_cursor OUT SYS_REFCURSOR  
)
IS

BEGIN
  
   OPEN PAR_OUT_CURSOR FOR
   /*SELECT B.C_DDCATL, C.C_DDCATL, A.C_COORDW, A.C_COORDE, 
          A.C_ALTURA, A.D_HORMUE, A.C_PH,     A.C_TEMPEC,
          A.C_CONDUC, A.C_TURBIE, A.C_OXIGEN, A.C_CLOROF,
          A.C_OBSERV, A.N_CODMUE */
   SELECT A.C_LOCMUE, A.C_ESTMUE, A.C_COORDW, A.C_COORDE, 
          A.C_ALTURA, A.D_HORMUE, A.C_PH,     A.C_TEMPEC,
          A.C_CONDUC, A.C_TURBIE, A.C_OXIGEN, A.C_CLOROF,
          A.C_OBSERV, A.N_CODMUE
                 
   FROM ALC_MUESTRFOR242 A 
        INNER JOIN ALC_DETCATLG B ON A.C_LOCMUE = B.C_VALCAT AND B.N_CCATLG = 3
        INNER JOIN ALC_DETCATLG C ON A.C_ESTMUE = C.C_VALCAT AND C.N_CCATLG = 6
        
   WHERE A.N_CODMUE = P_ID_DETALLE AND A.N_STATUS = 1;

END;

PROCEDURE PRC_UPDATE_DETALLE(
  
   P_LOCALIDAD_MUESTREO          ALC_MUESTRFOR242.C_LOCMUE%TYPE,
   P_ESTACION_MUESTREO           ALC_MUESTRFOR242.C_ESTMUE%TYPE,
   P_ALTURA                      ALC_MUESTRFOR242.C_ALTURA%TYPE,
   P_HORA                        IN VARCHAR2, -- ALC_MUESTRFOR242.D_HORMUE%TYPE,
   P_COORD_W                     ALC_MUESTRFOR242.C_COORDW%TYPE,
   P_COORD_E                     ALC_MUESTRFOR242.C_COORDE%TYPE,
   P_PH                          ALC_MUESTRFOR242.C_PH%TYPE,
   P_TEMPERATURA                 ALC_MUESTRFOR242.C_TEMPEC%TYPE,
   P_CONDUCTIVIDAD               ALC_MUESTRFOR242.C_CONDUC%TYPE,
   P_TURBIEDAD                   ALC_MUESTRFOR242.C_TURBIE%TYPE,
   P_OXIGENO                     ALC_MUESTRFOR242.C_OXIGEN%TYPE,
   P_CLOROFILA                   ALC_MUESTRFOR242.C_CLOROF%TYPE,
   /*P_FICO                        ALC_MUESTRFOR242.C_F*/
   P_OBSERVACION                 ALC_MUESTRFOR242.C_OBSERV%TYPE,
   P_CODIGO_DETALLE              ALC_MUESTRFOR242.N_CODMUE%TYPE,
   --Campos de Auditoria
   A_PAR_USUARIO_MODIFICACION    ALC_MUESTRFOR242.A_USUMOD%TYPE
 )
 IS
 BEGIN
   
  UPDATE ALC_MUESTRFOR242
  SET  
         A_USUMOD = A_PAR_USUARIO_MODIFICACION,
         C_LOCMUE = P_LOCALIDAD_MUESTREO,
         C_ESTMUE = P_ESTACION_MUESTREO,
         C_ALTURA = P_ALTURA,
         D_HORMUE = P_HORA,
         C_COORDW = P_COORD_W,
         C_COORDE = P_COORD_E,
         C_PH     = P_PH,
         C_TEMPEC = P_TEMPERATURA,
         C_CONDUC = P_CONDUCTIVIDAD,
         C_TURBIE = P_TURBIEDAD,
         C_OXIGEN = P_OXIGENO,
         C_CLOROF = P_CLOROFILA,
         C_OBSERV = P_OBSERVACION
       
  WHERE N_CODMUE = P_CODIGO_DETALLE;
  
END;

PROCEDURE PRC_UPDATE_HEADER242(
  
   P_ID_HEADER                      ALC_FORMULHEADER.N_CODHFO%TYPE,
   P_FECHA_MUESTREO                 IN VARCHAR2,
   P_FECHA_RECEPCION                IN VARCHAR2,
   P_PERSONA_MUESTREA               ALC_FORMULHEADER.C_PERMUE%TYPE,
   P_PERSONA_RECEPCION              ALC_FORMULHEADER.C_PERECE%TYPE,
   P_OBSERVACION                    ALC_FORMULHEADER.C_OBSERV%TYPE,  
   
   ---AUDITORIA---
   P_USUARIO_MODIF                  ALC_FORMULHEADER.A_USUMOD%TYPE,
   P_NOMBRE_PROG                    ALC_FORMULHEADER.A_NOMPRG%TYPE
 )
 IS
 BEGIN
   
  UPDATE ALC_FORMULHEADER H
  SET  
         H.A_USUMOD = P_USUARIO_MODIF,
         H.A_FECMOD = SYSDATE,
         H.A_NOMPRG = P_NOMBRE_PROG,
         H.D_FECMUE = TO_DATE(P_FECHA_MUESTREO, 'DD/MM/YYYY HH24:MI:SS'),
         H.D_RECMUE = TO_DATE(P_FECHA_RECEPCION, 'DD/MM/YYYY HH24:MI:SS'),
         H.C_PERMUE = P_PERSONA_MUESTREA,  
         H.C_PERECE = P_PERSONA_RECEPCION,
         H.C_OBSERV = P_OBSERVACION
          
  WHERE H.N_CODHFO = P_ID_HEADER;
  
END;

end PKC_ALC_FORM242;
